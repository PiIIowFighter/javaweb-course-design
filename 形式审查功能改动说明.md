# 形式审查功能改动说明

**目前的代码基于 javaweb-course-design-dev - cp 版本编写，并非最新。**

## 快速开始

### 数据库同步（首次部署或升级）

在运行代码之前，需要先执行数据库同步脚本，以确保数据库包含形式审查功能所需的所有表和字段。

**推荐方式：使用完整的同步脚本**

```sql
-- 在 SQL Server Management Studio (SSMS) 中打开并执行
-- sync_formal_check_database.sql 文件
```

sqlserver.sql是最新的sql文件，
sync_formal_check_database.sql是添加了以下新增内容的文件。

**数据库新增内容：**
- 新增表：`FormalCheckResults`（形式审查结果表）
- 新增字段：`Manuscripts.LastStatusTime`（最后状态变更时间）
- 新增字段：`FormalCheckResults.SimilarityScore`（查重相似度）
- 新增字段：`FormalCheckResults.HighSimilarity`（高相似度标记）
- 新增字段：`FormalCheckResults.PlagiarismReportUrl`（查重报告URL）
- 状态更新：`Manuscripts.Status` 约束新增 `FORMAL_CHECK` 和 `RETURNED`，移除 `Incomplete Submission`

---

## 1. 新增的形式审查功能流程描述

### 1.1 整体流程
形式审查功能是投稿系统中的关键环节，用于在稿件进入学术审稿前检查稿件格式和内容是否符合期刊要求。整个流程如下：

1. **作者提交稿件** → 稿件状态变为"FORMAL_CHECK"（形式审查中）
2. **编辑部管理员查看待审查稿件** → 在形式审查列表页面查看
3. **执行形式审查** → 系统自动检查部分项目，人工审核部分项目
4. **提交审查结果** → 
   - 若通过：稿件状态变为"DESK_REVIEW_INITIAL"（初审）
   - 若不通过：稿件状态变为"RETURNED"（已退回），发送邮件通知作者
5. **作者修改并重新提交** → 稿件重新进入形式审查流程

### 1.2 详细流程说明

#### 1.2.1 作者提交稿件
- 作者在投稿页面填写稿件信息并上传附件
- 提交后，稿件状态自动变为"FORMAL_CHECK"
- 系统发送邮件通知编辑部管理员有新稿件需要形式审查

#### 1.2.2 编辑部管理员审查
- 编辑部管理员登录系统，进入"形式审查"模块
- 查看待审查稿件列表，按提交时间排序
- 点击稿件进入详情页面，查看稿件信息和自动检查结果

#### 1.2.3 执行形式审查
**自动检查项目（系统自动完成）：**
- 作者信息检查：检查通讯作者邮箱是否为机构邮箱
- 摘要字数检查：检查摘要字数是否在150-700字之间
- 正文字数检查：检查正文字数是否在3000-8000字之间
- 关键词个数检查：检查关键词数量是否在3-7个之间
- 查重率检查：调用查重服务（仅模拟Turnitin，暂未接入API），获取相似度报告

**人工审核项目（需要管理员手动判断）：**
- 注释编号格式：检查正文注释是否使用①、②连续编号
- 参考文献格式：检查参考文献引用是否使用[1][2-5]格式
- 图表格式：检查图表是否按出现顺序独立编号

#### 1.2.4 提交审查结果
- 管理员根据检查结果选择"通过"或"不通过"
- 若选择"不通过"，需要填写反馈意见
- 系统自动生成反馈意见（基于检查结果）
- 提交后，系统更新稿件状态并发送邮件通知

#### 1.2.5 作者修改并重新提交
- 作者收到退回修改邮件，邮件中包含详细的问题列表和修改指南
- 作者登录系统，在"Revision（待修改）"标签页查看待修改稿件
- 点击稿件进入详情页面，查看反馈意见
- 修改稿件内容后，点击"重新提交"按钮
- 稿件重新进入形式审查流程


## 2. 具体实现的代码文件
### 2.1 新增的Java文件
#### 2.1.1 模型层（Model）
- **FormalCheckResult.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/model/FormalCheckResult.java`
  - 功能：形式审查结果模型类，包含所有检查项的结果字段
  - 主要字段：
    - manuscriptId：稿件ID
    - reviewerId：审查人ID
    - checkTime：审查时间
    - checkResult：审查结果（PASS/FAIL）
    - authorInfoValid：作者信息是否合格
    - abstractWordCountValid：摘要字数是否合格
    - bodyWordCountValid：正文字数是否合格
    - keywordsValid：关键词是否合格
    - footnoteNumberingValid：注释编号是否合格
    - figureTableFormatValid：图表格式是否合格
    - referenceFormatValid：参考文献格式是否合格
    - similarityScore：查重相似度
    - highSimilarity：是否高相似度（>20%）
    - plagiarismReportUrl：查重报告URL
    - feedback：反馈意见

#### 2.1.2 数据访问层（DAO）
- **FormalCheckResultDAO.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/dao/FormalCheckResultDAO.java`
  - 功能：形式审查结果的数据访问对象
  - 主要方法：
    - save(FormalCheckResult result)：保存审查结果
    - findByManuscriptId(int manuscriptId)：根据稿件ID查找审查结果
    - findLatestByManuscriptId(int manuscriptId)：查找最新的审查结果
    - update(FormalCheckResult result)：更新审查结果

#### 2.1.3 服务层（Service）
- **FormalCheckService.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/service/FormalCheckService.java`
  - 功能：形式审查业务逻辑服务
  - 主要方法：
    - performAutomaticChecks(Manuscript manuscript, String bodyText)：执行自动检查
    - performAutomaticChecksWithPlagiarism(Manuscript manuscript, String bodyText)：执行自动检查（含查重）
    - performPlagiarismCheck(Manuscript manuscript, String bodyText)：执行查重检查
    - generateFeedback(FormalCheckResult result)：生成反馈意见
    - checkAuthorInfo(Manuscript manuscript)：检查作者信息
    - checkAbstractWordCount(String abstractText)：检查摘要字数
    - checkBodyWordCount(String bodyText)：检查正文字数
    - checkKeywords(String keywords)：检查关键词

- **PlagiarismCheckService.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/service/PlagiarismCheckService.java`
  - 功能：查重服务（模拟Turnitin）
  - 主要方法：
    - checkPlagiarism(int manuscriptId, String title, String abstractText, String bodyText)：执行查重
    - generateSimilarityScore(String text)：生成相似度分数（模拟）
    - generateReportUrl(int manuscriptId)：生成报告URL（模拟）

### 2.2 修改的Java文件
#### 2.2.1 控制器层（Controller）
- **EditorServlet.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/controller/EditorServlet.java`
  - 修改内容：
    - 新增 `handleFormalCheckList` 方法：处理形式审查列表页面
    - 新增 `handleAutoCheck` 方法：执行自动检查
    - 新增 `handlePlagiarismCheck` 方法：执行查重检查
    - 新增 `handleSubmitFormalCheck` 方法：提交形式审查结果
    - 新增 `handleReturnForRevision` 方法：退回修改
  - URL映射：
    - `/editor/formal-check`：形式审查列表页面
    - `/editor/formal-check/auto-check`：执行自动检查
    - `/editor/formal-check/plagiarism-check`：执行查重检查
    - `/editor/formal-check/submit`：提交审查结果
    - `/editor/formal-check/return`：退回修改

- **ManuscriptServlet.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/controller/ManuscriptServlet.java`
  - 修改内容：
    - 修改 `handleAuthorList` 方法：更新稿件状态分组逻辑
    - 修改 `matchGroup` 方法：将"RETURNED"状态归类到"revision"分组
    - 修改 `handleResubmit` 方法：支持重新提交被退回的稿件

#### 2.2.2 工具层（Util）
- **MailNotifications.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/util/mail/MailNotifications.java`
  - 修改内容：
    - 新增 `onFormalCheckReturn` 方法：发送形式审查退回邮件
    - 新增 `onFormalCheckPass` 方法：发送形式审查通过邮件

- **MailTemplates.java**
  - 位置：`src/main/java/edu/bjfu/onlinesm/util/mail/MailTemplates.java`
  - 修改内容：
    - 新增 `unsubmitReturn` 方法：生成退回修改邮件模板
    - 更新邮件内容：明确提示用户到"Revision（待修改）"标签页查看

### 2.3 新增的JSP文件

- **formal_check_list.jsp**
  - 位置：`src/main/webapp/WEB-INF/jsp/editor/formal_check_list.jsp`
  - 功能：形式审查列表页面
  - 主要内容：
    - 显示待审查稿件列表
    - 显示稿件基本信息（标题、作者、提交时间等）
    - 提供进入详情页面的链接
    - 提供执行自动检查和查重检查的按钮

### 2.4 修改的JSP文件

- **manuscript/detail.jsp**
  - 位置：`src/main/webapp/WEB-INF/jsp/manuscript/detail.jsp`
  - 修改内容：
    - 新增形式审查表单
    - 显示自动检查结果
    - 提供人工审核选项
    - 提供提交审查结果的按钮
    - 显示查重报告链接

- **editor_dashboard.jsp**
  - 位置：`src/main/webapp/WEB-INF/jsp/editor/editor_dashboard.jsp`
  - 修改内容：
    - 新增"形式审查"入口链接

- **auth_sidebar.jsp**
  - 位置：`src/main/webapp/WEB-INF/jsp/common/auth_sidebar.jsp`
  - 修改内容：
    - 新增"形式审查"菜单项（针对编辑部和EO管理员角色）

- **eo_admin_dashboard.jsp**
  - 位置：`src/main/webapp/WEB-INF/jsp/admin/eo_admin_dashboard.jsp`
  - 修改内容：
    - 新增"形式审查"入口链接

## 3. 数据库的改动

### 3.1 新增的表

#### 3.1.1 FormalCheckResults表
- **表名**：`dbo.FormalCheckResults`
- **功能**：存储形式审查结果
- **字段说明**：

| 字段名 | 数据类型 | 说明 | 约束 |
|--------|----------|------|------|
| CheckResultId | INT | 审查结果ID | 主键，自增 |
| ManuscriptId | INT | 稿件ID | 外键，关联Manuscripts表 |
| ReviewerId | INT | 审查人ID | 外键，关联Users表 |
| CheckTime | DATETIME2 | 审查时间 | 默认SYSUTCDATETIME() |
| CheckResult | NVARCHAR(10) | 审查结果 | 'PASS'或'FAIL' |
| AuthorInfoValid | BIT | 作者信息是否合格 | NULL表示未检查 |
| AbstractWordCountValid | BIT | 摘要字数是否合格 | NULL表示未检查 |
| BodyWordCountValid | BIT | 正文字数是否合格 | NULL表示未检查 |
| KeywordsValid | BIT | 关键词是否合格 | NULL表示未检查 |
| FootnoteNumberingValid | BIT | 注释编号是否合格 | NULL表示未检查 |
| FigureTableFormatValid | BIT | 图表格式是否合格 | NULL表示未检查 |
| ReferenceFormatValid | BIT | 参考文献格式是否合格 | NULL表示未检查 |
| SimilarityScore | DECIMAL(5,2) | 查重相似度 | 范围0-100 |
| HighSimilarity | BIT | 是否高相似度 | 1表示>20% |
| PlagiarismReportUrl | NVARCHAR(500) | 查重报告URL | |
| Feedback | NVARCHAR(MAX) | 反馈意见 | |

- **索引**：
  - `IX_FormalCheckResults_ManuscriptId`：在ManuscriptId字段上创建索引
  - `IX_FormalCheckResults_ReviewerId`：在ReviewerId字段上创建索引

- **外键约束**：
  - `FK_FormalCheckResults_Manuscripts`：关联Manuscripts表
  - `FK_FormalCheckResults_Users`：关联Users表

### 3.2 对原有表的改动

#### 3.2.1 Manuscripts表
- **表名**：`dbo.Manuscripts`
- **修改内容**：
  - 新增字段 `LastStatusTime DATETIME2`：记录最后一次状态变更时间

- **状态枚举值**：
  ```sql
  CONSTRAINT CK_Manuscripts_Status CHECK (Status IN (
      N'DRAFT',
      N'SUBMITTED',
      N'FORMAL_CHECK',
      N'RETURNED',
      N'DESK_REVIEW_INITIAL',
      N'TO_ASSIGN',
      N'WITH_EDITOR',
      N'UNDER_REVIEW',
      N'EDITOR_RECOMMENDATION',
      N'FINAL_DECISION_PENDING',
      N'REVISION',
      N'ACCEPTED',
      N'REJECTED',
      N'ARCHIVED'
  ))
  ```

### 3.3 数据库迁移脚本

#### 3.3.1 sync_formal_check_database.sql（推荐使用）
- **位置**：项目根目录
- **功能**：完整的形式审查功能数据库同步脚本
- **执行时机**：首次部署或升级时执行一次
- **包含内容**：
  - 检查并添加 `LastStatusTime` 字段到 `Manuscripts` 表
  - 创建 `FormalCheckResults` 表（包含所有字段）
  - 添加查重相关字段（`SimilarityScore`、`HighSimilarity`、`PlagiarismReportUrl`）
  - 更新 `Manuscripts` 表的状态约束（添加 `FORMAL_CHECK` 和 `RETURNED`，移除 `Incomplete Submission`）
  - 更新状态为"Incomplete Submission"的稿件为"RETURNED"
  - 验证数据库结构
  - 显示当前数据库状态统计
- **使用方法**：
  ```sql
  -- 在 SQL Server Management Studio (SSMS) 中执行
  -- 或使用 sqlcmd 命令行工具执行
  sqlcmd -S localhost -U sa -P your_password -i sync_formal_check_database.sql
  ```
- **特点**：
  - 幂等性：可重复执行，不会重复创建已存在的表或字段
  - 完整性：包含所有形式审查功能相关的数据库变更
  - 可验证：执行后会验证数据库结构并显示统计信息

#### 3.3.2 add_plagiarism_fields.sql（已废弃）
- **位置**：项目根目录
- **功能**：为FormalCheckResults表添加查重相关字段
- **说明**：此脚本已被 `sync_formal_check_database.sql` 替代，不再单独使用

#### 3.3.3 update_incomplete_status.sql（已废弃）
- **位置**：项目根目录
- **功能**：将状态为"Incomplete Submission"的稿件更新为"RETURNED"状态
- **说明**：此脚本已被 `sync_formal_check_database.sql` 替代，不再单独使用


## 4. 审查文件参考的URL以及参考文件

### 4.1 格式指南文档
- **URL**：`/static/guides/format_guide.pdf`
- **说明**：详细的格式指南文档，包含所有审查点的详细说明和示例
- **用途**：管理员在审查时参考，作者在修改时参考

### 4.2 论文审核标准文件（待添加）
- **位置**：待添加
- **说明**：包含参考文献格式、图表格式等详细审核标准
- **用途**：管理员在人工审核时参考

### 4.3 参考文件（待添加）
- [ ] 论文格式规范文档
- [ ] 参考文献格式示例
- [ ] 图表格式示例
- [ ] 查重服务使用说明

## 5. 前实现的功能描述

### 已实现的功能

#### 自动检查功能
- ✅ 作者信息检查（机构邮箱验证）
- ✅ 摘要字数检查（150-700字）
- ✅ 正文字数检查（3000-8000字）
- ✅ 关键词个数检查（3-7个）
- ✅ 查重率检查（模拟Turnitin，显示相似度）

#### 人工审核功能
- ✅ 注释编号格式审核
- ✅ 参考文献格式审核
- ✅ 图表格式审核

#### 审查结果管理
- ✅ 保存审查结果到数据库
- ✅ 生成自动反馈意见
- ✅ 支持手动补充反馈意见
- ✅ 审查结果历史记录

#### 稿件状态管理
- ✅ 自动更新稿件状态
- ✅ 形式审查不通过时退回修改
- ✅ 作者重新提交功能
- ✅ 稿件状态分组显示

#### 邮件通知功能
- ✅ 形式审查退回邮件通知
- ✅ 邮件包含详细问题列表
- ✅ 邮件包含修改指南
- ✅ 邮件包含稿件详情链接
- ✅ 提示用户到"Revision（待修改）"标签页查看

#### 前端界面功能
- ✅ 形式审查列表页面
- ✅ 稿件详情页面（包含审查表单）
- ✅ 自动检查结果展示
- ✅ 查重报告链接展示
- ✅ 稿件状态标签页切换

### 待实现的功能

#### 查重服务
- ⏳ 集成真实的Turnitin API
- ⏳ 实现真实的查重报告生成
- ⏳ 优化查重算法


## 6.使用说明

### 编辑部管理员使用流程

1. **登录系统**
   - 使用编辑部管理员账号登录
   - 进入"形式审查"模块

2. **查看待审查稿件**
   - 在形式审查列表页面查看所有待审查稿件
   - 按提交时间排序，优先处理早期提交的稿件

3. **执行自动检查**
   - 点击"执行自动检查"按钮
   - 系统自动检查作者信息、摘要字数、正文字数、关键词
   - 点击"执行查重检查"按钮
   - 系统调用查重服务，获取查重报告

4. **人工审核**
   - 查看自动检查结果
   - 人工审核注释编号、参考文献格式、图表格式
   - 选择"符合标准"或"不符合标准"

5. **提交审查结果**
   - 根据检查结果选择"通过"或"不通过"
   - 若选择"不通过"，填写反馈意见
   - 点击"提交"按钮
   - 系统自动更新稿件状态并发送邮件通知

### 作者使用流程

1. **提交稿件**
   - 在投稿页面填写稿件信息
   - 上传稿件附件
   - 点击"提交"按钮
   - 稿件状态变为"FORMAL_CHECK"

2. **查看审查结果**
   - 收到邮件通知后登录系统
   - 若审查通过，稿件进入初审流程
   - 若审查不通过，查看邮件中的问题列表

3. **修改稿件**
   - 登录系统，进入"我的稿件"页面
   - 切换到"Revision（待修改）"标签页
   - 查看待修改稿件列表
   - 点击稿件进入详情页面
   - 查看反馈意见和修改指南
   - 修改稿件内容

4. **重新提交**
   - 修改完成后，点击"重新提交"按钮
   - 稿件重新进入形式审查流程
   - 等待编辑部管理员再次审查

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-12-26 | 初始版本，实现基本的形式审查功能 |

## 联系方式

如有问题或建议，请联系开发团队。
